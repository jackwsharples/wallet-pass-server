<!-- Redeem-only snippet: paste into a general “enter your code” page on WordPress.
     Set API_BASE below. -->
<div id="discount-redeem">
  <form id="redeem-form" style="display:grid; gap:8px; max-width:360px;">
    <label>Enter your discount code
      <input id="redeem-code" required placeholder="ABC123XYZ" style="width:100%; padding:10px;">
    </label>
    <button type="submit" style="padding:10px; background:#2563eb; color:white; border:0; cursor:pointer; border-radius:6px;">Download Wallet Pass</button>
    <div id="redeem-status" style="font-size:12px; color:#444;"></div>
  </form>
</div>

<script>
(() => {
  const API_BASE = 'https://wallet-pass-server-production.up.railway.app'; // <-- set to Railway backend origin
  const redeemForm = document.getElementById('redeem-form');
  const redeemCodeInput = document.getElementById('redeem-code');
  const redeemStatus = document.getElementById('redeem-status');

  redeemForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    redeemStatus.textContent = 'Validating code...';
    redeemStatus.style.color = '#444';
    const code = redeemCodeInput.value.trim();

    try {
      const res = await fetch(`${API_BASE}/api/redeem-code`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors',
        body: JSON.stringify({ code })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        redeemStatus.textContent = err.error || 'Invalid or used code.';
        redeemStatus.style.color = '#b91c1c';
        return;
      }

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'discount_card.pkpass';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      redeemStatus.textContent = 'Download started.';
      redeemStatus.style.color = '#15803d';
    } catch (err) {
      console.error(err);
      redeemStatus.textContent = 'Something went wrong. Please try again.';
      redeemStatus.style.color = '#b91c1c';
    }
  });
})();
</script>
